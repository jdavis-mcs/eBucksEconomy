<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Store Kiosk</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; } /* Slate 900 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .receipt-pattern {
            background-color: #ffffff;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 10px 10px;
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden selection:bg-red-200">

    <button onclick="document.getElementById('app-drawer').classList.remove('-translate-x-full')" 
        class="fixed top-4 left-4 z-50 bg-slate-800 text-white p-2 rounded-lg shadow-xl hover:bg-red-600 transition-colors border border-slate-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
    </button>

    <div id="app-drawer" class="fixed inset-y-0 left-0 w-72 bg-slate-900 shadow-2xl z-[60] transform -translate-x-full transition-transform duration-300 ease-in-out border-r border-slate-800 flex flex-col">
        <div class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-950">
            <span class="font-black text-white tracking-tighter text-lg">E-BUCKS <span class="text-red-600">OS</span></span>
            <button onclick="document.getElementById('app-drawer').classList.add('-translate-x-full')" class="text-slate-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
        <div class="p-4 grid grid-cols-2 gap-3">
            <a href="/" class="flex flex-col items-center justify-center bg-slate-800 hover:bg-slate-700 p-3 rounded-lg border border-slate-700 transition text-center group"><span class="text-2xl mb-1 group-hover:scale-110 transition-transform">üè†</span><span class="text-xs font-bold text-slate-300">Home</span></a>
            <a href="store.html" class="flex flex-col items-center justify-center bg-slate-800 hover:bg-slate-700 p-3 rounded-lg border border-slate-700 transition text-center group"><span class="text-2xl mb-1 group-hover:scale-110 transition-transform">üõí</span><span class="text-xs font-bold text-slate-300">Store</span></a>
            <a href="admin.html" class="flex flex-col items-center justify-center bg-slate-800 hover:bg-slate-700 p-3 rounded-lg border border-slate-700 transition text-center group"><span class="text-2xl mb-1 group-hover:scale-110 transition-transform">‚öôÔ∏è</span><span class="text-xs font-bold text-slate-300">Admin</span></a>
            <a href="timeclock.html" class="flex flex-col items-center justify-center bg-slate-800 hover:bg-slate-700 p-3 rounded-lg border border-slate-700 transition text-center group"><span class="text-2xl mb-1 group-hover:scale-110 transition-transform">‚è∞</span><span class="text-xs font-bold text-slate-300">Clock</span></a>
        </div>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- PRINT HELPER ---
        const handlePrintResponse = (data) => {
            if (data && data.printWindow) {
                const printWindow = window.open('', '_blank', 'width=400,height=600');
                if (printWindow) {
                    printWindow.document.write(data.printWindow);
                    printWindow.document.close();
                } else {
                    alert("‚ö†Ô∏è Popups are blocked! Please allow popups for this site.");
                }
            }
        };

        function StoreApp() {
            const [inventory, setInventory] = useState([]);
            const [cart, setCart] = useState([]);
            const [isPaymentOpen, setIsPaymentOpen] = useState(false);
            const [scannedVouchers, setScannedVouchers] = useState([]);
            const [voucherInput, setVoucherInput] = useState("");
            const [processing, setProcessing] = useState(false);
            const voucherInputRef = useRef(null);

            useEffect(() => {
                fetch('/api/inventory').then(r => r.json()).then(setInventory);
            }, []);

            useEffect(() => {
                if (isPaymentOpen && voucherInputRef.current) {
                    voucherInputRef.current.focus();
                }
            }, [isPaymentOpen]);

            const addToCart = (item) => {
                setCart(prev => {
                    const existing = prev.find(i => i.id === item.id);
                    if (existing) {
                        return prev.map(i => i.id === item.id ? { ...i, qty: i.qty + 1 } : i);
                    }
                    return [...prev, { ...item, qty: 1 }];
                });
            };

            const removeFromCart = (id) => setCart(prev => prev.filter(i => i.id !== id));
            const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

            const handleVoucherSubmit = (e) => {
                e.preventDefault();
                if(!voucherInput.trim()) return;
                if (!scannedVouchers.includes(voucherInput.trim())) {
                    setScannedVouchers([...scannedVouchers, voucherInput.trim()]);
                }
                setVoucherInput("");
            };

            const finishTransaction = async () => {
                if(scannedVouchers.length === 0) return alert("Please scan at least one voucher.");
                setProcessing(true);

                let printItems = [];
                cart.forEach(i => {
                    for(let x=0; x<i.qty; x++) printItems.push(i);
                });

                const payload = {
                    voucherIds: scannedVouchers,
                    totalCost: cartTotal,
                    cartItems: printItems
                };

                try {
                    const res = await fetch('/api/purchase', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();

                    if (data.success) {
                        setCart([]);
                        setScannedVouchers([]);
                        setIsPaymentOpen(false);
                        // --- TRIGGER PRINT ---
                        handlePrintResponse(data); 
                    } else {
                        alert("ERROR: " + (data.error || "Transaction Failed"));
                        setScannedVouchers([]); 
                    }
                } catch (e) {
                    alert("Network Error");
                }
                setProcessing(false);
            };

            useEffect(() => {
                let buffer = "";
                let timeout = null;
                const handleKeyDown = (e) => {
                    if (isPaymentOpen) return;
                    if (e.target.tagName === 'INPUT') return;
                    if (e.key === 'Enter') {
                        if (buffer.length > 0) {
                            const found = inventory.find(i => i.name.toLowerCase() === buffer.toLowerCase());
                            if (found) addToCart(found);
                            buffer = "";
                        }
                    } else if (e.key.length === 1) {
                        buffer += e.key;
                        clearTimeout(timeout);
                        timeout = setTimeout(() => buffer = "", 100);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [inventory, isPaymentOpen]);

            return (
                <div className="flex h-screen w-full">
                    <div className="w-2/3 h-full bg-slate-900 p-6 overflow-y-auto flex flex-col pl-20">
                        <div className="mb-6"><h1 className="text-3xl font-black text-white">CLASS <span className="text-red-600">STORE</span></h1><p className="text-slate-400 text-sm">Tap an item to add to cart</p></div>
                        <div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                            {inventory.map(item => (
                                <button key={item.id} onClick={() => addToCart(item)} className="bg-slate-800 border-2 border-slate-700 hover:border-red-500 hover:bg-slate-700 rounded-xl p-4 flex flex-col items-center justify-between aspect-square transition-all group shadow-lg"><div className="bg-slate-900/50 w-full flex-1 rounded-lg mb-3 flex items-center justify-center text-4xl group-hover:scale-110 transition-transform">üì¶</div><div className="w-full text-left"><div className="font-bold text-white leading-tight mb-1">{item.name}</div><div className="font-mono text-green-400 font-bold">${item.price.toFixed(2)}</div><div className="text-xs text-slate-500 mt-1">{item.stock} in stock</div></div></button>
                            ))}
                        </div>
                    </div>
                    <div className="w-1/3 h-full bg-slate-100 flex flex-col border-l border-slate-300 shadow-2xl relative z-10">
                        <div className="bg-white p-6 border-b border-dashed border-slate-300 shadow-sm relative z-20"><div className="text-center"><h2 className="font-black text-2xl uppercase tracking-widest text-slate-900">Receipt</h2><p className="text-xs text-slate-500 uppercase tracking-widest">{new Date().toLocaleDateString()}</p></div></div>
                        <div className="flex-1 overflow-y-auto p-4 receipt-pattern relative">
                            {cart.length === 0 ? <div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-50"><span className="text-6xl mb-4">üõí</span><p className="font-bold uppercase tracking-widest">Cart Empty</p></div> : 
                                <div className="space-y-3">{cart.map((item, idx) => (<div key={idx} className="flex justify-between items-center group"><div className="flex flex-col"><span className="font-bold text-slate-800 text-lg">{item.name}</span><span className="text-xs text-slate-500">Qty: {item.qty} x ${item.price.toFixed(2)}</span></div><div className="flex items-center gap-3"><span className="font-mono font-bold text-lg">${(item.price * item.qty).toFixed(2)}</span><button onClick={() => removeFromCart(item.id)} className="text-red-400 hover:text-red-600 font-bold text-xl px-2">√ó</button></div></div>))}</div>}
                        </div>
                        <div className="bg-white p-6 border-t border-slate-200 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] relative z-30"><div className="flex justify-between items-end mb-6"><span className="text-sm font-bold text-slate-500 uppercase">Total Due</span><span className="text-4xl font-black text-slate-900">${cartTotal.toFixed(2)}</span></div><button onClick={() => cartTotal > 0 ? setIsPaymentOpen(true) : alert("Cart is empty")} className={`w-full py-4 rounded-xl font-black text-xl tracking-widest shadow-lg transition-transform active:scale-95 ${cartTotal > 0 ? 'bg-red-600 text-white hover:bg-red-500' : 'bg-slate-300 text-slate-400 cursor-not-allowed'}`}>PAY NOW</button></div>
                    </div>
                    {isPaymentOpen && (
                        <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="bg-slate-950 p-6 border-b border-slate-800 flex justify-between items-center"><h2 className="text-2xl font-black text-white flex items-center gap-3"><span>üí≥</span> Self Checkout</h2><button onClick={() => setIsPaymentOpen(false)} className="text-slate-400 hover:text-white px-4 py-2 bg-slate-800 rounded-lg text-sm font-bold">CANCEL</button></div>
                                <div className="p-8 flex-1 overflow-y-auto">
                                    <div className="text-center mb-8"><p className="text-slate-400 uppercase text-sm font-bold tracking-widest mb-2">Total Amount Due</p><div className="text-6xl font-black text-white">${cartTotal.toFixed(2)}</div></div>
                                    <div className="mb-8"><form onSubmit={handleVoucherSubmit} className="relative"><input ref={voucherInputRef} type="text" value={voucherInput} onChange={(e) => setVoucherInput(e.target.value)} className="w-full bg-slate-800 border-2 border-blue-500 text-white text-center text-xl font-mono py-4 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-500/20 placeholder-slate-600" placeholder="Scan Voucher Barcode Here..." autoFocus /><div className="absolute right-4 top-1/2 -translate-y-1/2"><svg className="w-6 h-6 text-blue-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 17h.01M9 17h.01M12 17v-3m0 0h.01M12 17h.01"/></svg></div></form><p className="text-center text-slate-500 text-xs mt-3">Use your scanner or type code and hit Enter.</p></div>
                                    <div className="bg-slate-950 rounded-xl p-4 border border-slate-800"><h3 className="text-slate-400 text-xs font-bold uppercase mb-3">Scanned Vouchers ({scannedVouchers.length})</h3><div className="space-y-2 max-h-40 overflow-y-auto">{scannedVouchers.length === 0 && <p className="text-slate-600 italic text-sm text-center py-4">Waiting for scan...</p>}{scannedVouchers.map((code, i) => (<div key={i} className="flex justify-between items-center bg-slate-900 p-3 rounded border border-slate-800"><span className="font-mono text-blue-400 font-bold tracking-widest">{code}</span><span className="text-green-500 text-xs font-bold">READY</span></div>))}</div></div>
                                </div>
                                <div className="p-6 bg-slate-950 border-t border-slate-800"><button onClick={finishTransaction} disabled={processing || scannedVouchers.length === 0} className={`w-full py-4 rounded-xl font-black text-xl uppercase tracking-widest transition-all ${processing ? 'bg-slate-700 text-slate-500' : scannedVouchers.length > 0 ? 'bg-green-500 hover:bg-green-400 text-white shadow-[0_0_20px_rgba(34,197,94,0.4)]' : 'bg-slate-800 text-slate-600'}`}>{processing ? "Processing..." : scannedVouchers.length > 0 ? "Complete Transaction" : "Scan to Pay"}</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StoreApp />);
    </script>
</body>
</html>